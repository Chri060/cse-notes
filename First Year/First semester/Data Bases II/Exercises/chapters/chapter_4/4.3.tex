\section{Exercise 3}

Consider the following relational schema:
\begin{itemize}
    \item STUDENT (\underline{ID}, Name, Address, Phone, Faculty, Year1, Campus, EarnedCredits)
    \item ENROLLMENT (\underline{StudID}, \underline{CourseCode}, \underline{Year1}, Date)
    \item EDITION (\underline{CourseCode}, \underline{Year1}, Teacher, Semester, \#Students, \#ExternalStuds)
    \item COURSE (\underline{CourseCode}, Name, Credits, Campus)
\end{itemize}
\begin{enumerate}
    \item Write a trigger that rolls back the creation of a new ENROLLMENT if the referenced STUDENT and/or EDITION does not exist in the corresponding table. 
    \item The \#ExternalStuds attribute in EDITION represents the number of students enrolled to the course, that are associated to a different Campus with respect to the one where the COURSE is held.
        Write a trigger that updates (if needed) the value of EDITION.\#ExternalStuds when a Student moves from a campus to another.
\end{enumerate}

\paragraph*{Solution}
\begin{enumerate}
    \item The requested trigger is: 
        \begin{lstlisting}[style=SQL]
CREATE TRIGGER CheckEnrollment
AFTER INSERT ON ENROLLMENT
WHEN NOT EXISTS ( 
    SELECT *
    FROM STUDENT
    WHERE ID = NEW.StudID 
    )
OR NOT EXISTS ( 
    SELECT *
    FROM EDITION
    WHERE CourseCode = NEW.CourseCode AND Year1 = NEW.Year1 
    )
ROLLBACK;
        \end{lstlisting}
    \item Modifying the Campus of a student has the following effects. 
        The student becomes an “External” student for all the courses he is enrolled into that are located in the campus he is leaving. 
        The student becomes an “Internal” student for all his courses located in the campus where he is moving.
        There are two counters to update.
        The requested triggers are:
        \begin{lstlisting}[style=SQL]
CREATE TRIGGER CheckCampus1
AFTER UPDATE OF Campus ON STUDENT
FOR EACH ROW
BEGIN
    UPDATE EDITION
    SET #ExternalStuds = #ExternalStuds + 1
    WHERE (CourseCode, Year1) IN (
        SELECT CourseCode, Year1
        FROM ENROLLMENT
        WHERE StudID = OLD.ID 
        )
    AND CourseCode IN ( 
        SELECT CourseCode
        FROM COURSE
        WHERE Campus = OLD.Campus 
        );
END

CREATE TRIGGER CheckCampus2
AFTER UPDATE OF Campus ON STUDENT
FOR EACH ROW
BEGIN
    UPDATE EDITION
    SET #ExternalStuds = #ExternalStuds - 1
    WHERE (CourseCode,Year1) IN (
        SELECT CourseCode, Year1
        FROM ENROLLMENT
        WHERE StudID = OLD.ID
        )
    AND CourseCode IN ( 
        SELECT CourseCode
        FROM COURSE
        WHERE Campus = NEW.Campus
        );
END
        \end{lstlisting}
        The use of old/new is fundamental to distinguishing the values of the Campus attribute and to identify the campus that the students are leaving/joining. 
        Instead, using old or new is equivalent for the ID attribute (that value is not changed by the update event).
        If (by any chance) the update re-assigns to the Campus attribute the same value (i.e., if old.Campus = new.Campus), the counters remain unaltered.
\end{enumerate}