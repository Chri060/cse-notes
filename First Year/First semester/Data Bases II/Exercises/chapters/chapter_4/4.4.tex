\section{Exercise 4}

A logistics company manages shipments via trucks. Each driver owns one or more trucks and has a number of colleagues who can drive his/her trucks. 
A truck makes zero or more trips. 
A trip specifies that a given truck must travel from an origin to a destination on a certain date. 
When the driver completes a trip, a report is created with the number of hours traveled. 
The following logical schema is given:
\begin{itemize}
    \item TRUCK(\underline{plate}, status, ownerId) 
    \item DRIVER(\underline{id}, hoursTraveled, status) 
    \item TRIP(\underline{TripId}, date, origin, destination, truckPlate, driverId)
    \item TRIPREPORT(\underline{tripId}, \underline{hoursTraveled})
    \item ALTERNATE(\underline{driverId}, \underline{alternativeDriverId})
\end{itemize}
Suppose that when a new trip is created, the initial values for the truckPlate and driverId are set to \texttt{NULL}. 
Design a set of triggers that implement the following behaviors: 
\begin{enumerate}
    \item When a truck is assigned to a trip, if the status of the truck is maintenance the operation is prevented from proceeding, and the trigger raises an exception with text Truck under maintenance. 
        After the assignment of an available truck to a trip, a trigger tries to automatically assign a suitable driver, giving priority to the truck's owner. 
        He/she can be assigned only if his/her status is authorized and he/she is available for that date. 
        Otherwise, an alternate driver is searched: the one with the least cumulative travel hours among those with authorized status available for that date is chosen. 
        If a suitable driver is not found, the trigger raises an exception with text No driver available.
    \item When a trip report is created, the total number of hours traveled by the driver must be updated. 
        If the hours s/he has traveled exceeds 1000, his/her status is set to non-authorized and his/her assignments to the trips posterior to the reported one are set to \texttt{NULL}.
\end{enumerate}

\paragraph*{Solution}
\begin{enumerate}
    \item The requested triggers are: 
        \begin{lstlisting}[style=SQL]
CREATE TRIGGER CheckMaintenance
BEFORE UPDATE OF truckPlate ON TRIP
FOR EACH ROW
BEGIN
    DECLARE truck_status VARCHAR(20);
    SELECT status INTO truck_status
    FROM TRUCK
    WHERE PLATE = NEW.truckPlate;
    IF truck_status = 'maintenance' THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Truck under maintenance';
    END;
END;

CREATE TRIGGER AssignDriver
AFTER UPDATE OF truckPlate ON TRIP
FOR EACH ROW
BEGIN
    DECLARE owner_id INT;
    DECLARE suitable_driver_id INT;
    SELECT ownerId INTO owner_id
    FROM TRUCK
    WHERE PLATE = NEW.truckPlate;
    SELECT ID INTO suitable_driver_id
    FROM DRIVER
    WHERE ID = owner_id AND status = 'authorized'
    AND NOT EXISTS (
        SELECT *
        FROM TRIP T
        WHERE T.driverId = owner_id
        AND T.date = NEW.date
    )
    IF suitable_driver_id IS NULL THEN
        SELECT A.ALTERNATEDRIVERID INTO suitable_driver_id
        FROM ALTERNATE A
        JOIN DRIVER D ON A.ALTERNATEDRIVERID = D.ID
        WHERE A.DRIVERID = owner_id
        AND D.status = 'authorized'
        AND NOT EXISTS (
            SELECT *
            FROM TRIP T
            WHERE T.driverId = A.ALTERNATEDRIVERID
            AND T.date = NEW.date
            )
        ORDER BY D.hoursTravelled ASC
        LIMIT 1;
    END IF;
    IF suitable_driver_id IS NOT NULL THEN
        UPDATE TRIP
        SET driverId = suitable_driver_id
        WHERE NEW.TRIPID = TRIPID;
    ELSE
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'No driver available';
    END IF;
END;

CREATE TRIGGER UpdateHours
AFTER INSERT ON TRIPREPORT
FOR EACH ROW
BEGIN
    UPDATE DRIVER
    SET hoursTraveled += NEW.hoursTraveled
    WHERE ID = (SELECT driverId FROM TRIP WHERE TRIPID = NEW.TRIPID);
END;

CREATE TRIGGER UpdateDriverStatus
AFTER UPDATE OF hoursTraveled ON DRIVER
FOR EACH ROW
WHEN NEW.hoursTraveled > 1000
    BEGIN
        UPDATE DRIVER
        SET status = 'non-authorized'
        WHERE ID = NEW.ID;
        UPDATE TRIP
        SET driverId = NULL
        WHERE driverId = (SELECT driverId FROM TRIP WHERE TRIPID = NEW.TRIPID)
        AND date > NOW();
    END;
        \end{lstlisting}
\end{enumerate}