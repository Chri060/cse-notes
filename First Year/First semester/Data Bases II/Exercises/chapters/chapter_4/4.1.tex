\section{Exercise 1}

Consider the following relational schema: 
\begin{itemize}
    \item EXAMINATION (\underline{StudentID}, \underline{Course}, EDate, Grade)
    \item PRECEDENCERULE (\underline{PrecedingCourse}, \underline{FollowingCourse})
\end{itemize}
With the following integrity constraint: it is forbidden to take an exam if there is a preceding course that has not been passed yet.
\begin{enumerate}
    \item Find the operations that can violate the constraint.
    \item Based on the common sense experience, choose the operation that will actually violate the constraint. 
    \item Write a trigger for that operation, that rolls back the effects when the constraint is violated. 
\end{enumerate}

\paragraph*{Solution}
\begin{enumerate}
    \item The operations that can violate the integrity constraint are: 
        \begin{itemize}
            \item \texttt{INSERT} of a new EXAMINATION, when there are preceding courses that are not sustained.
            \item \texttt{UPDATE} of the Date or Course on EXAMINATION.
            \item \texttt{DELETE} of an EXAMINATION.
            \item \texttt{UPDATE} of an existing PRECEDENCERULE.
            \item \texttt{INSERT} of a new PRECEDENCERULE.
        \end{itemize}
    \item The operation that most typically will violate the rule is the first one.
        Updates and deletions on examinations should occur exceptionally, and only to handle specific errors. 
        Changes to precedence rules, instead, may affect older exams.
        One solution to this issue is to extend the schema with a date from which the precedence rule is activated and a date in which the rule is to be considered invalidated.
    \item The requested trigger is: 
        \begin{lstlisting}[style=SQL]
CREATE TRIGGER MissingPrecedence
BEFORE INSERT ON EXAMINATION
FOR EACH ROW
WHEN EXISTS ( 
    SELECT *
    FROM PRECEDENCERULE
    WHERE FollowingCourse = NEW.Course 
        AND PrecedingCourse NOT IN (
            SELECT Course
            FROM EXAMINATION
            WHERE StudentID = NEW.StudentID
            AND EDate < NEW.EDate) 
    )
ROLLBACK;
        \end{lstlisting}
\end{enumerate}